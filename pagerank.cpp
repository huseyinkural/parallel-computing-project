#include <stdio.h>
#include <cmath>

// CUDA kernel for PageRank calculation
__global__ void pagerank_kernel(float *d_matrix, float *d_vector, float *d_result, int num_nodes, float damping_factor) {
    int tid = blockIdx.x * blockDim.x + threadIdx.x;

    if (tid < num_nodes) {
        float sum = 0.0f;
        for (int i = 0; i < num_nodes; ++i) {
            sum += d_matrix[tid * num_nodes + i] * d_vector[i];
        }
        d_result[tid] = (1.0f - damping_factor) / num_nodes + damping_factor * sum;
    }
}

int main() {
    const int num_nodes = 6;
    const float damping_factor = 0.85f;
    const int num_iterations = 200;
    const float epsilon = 1e-5; // Adjusted convergence threshold

    // Initialize your graph matrix and initial PageRank vector
    float matrix[num_nodes * num_nodes] = {0.0f, 0.2f, 0.3f, 0.1f, 0.0f, 0.4f,
                                           0.1f, 0.0f, 0.0f, 0.6f, 0.1f, 0.0f,
                                           0.2f, 0.1f, 0.0f, 0.0f, 0.5f, 0.2f,
                                           0.0f, 0.5f, 0.2f, 0.0f, 0.0f, 0.3f,
                                           0.4f, 0.0f, 0.1f, 0.0f, 0.0f, 0.5f,
                                           0.0f, 0.3f, 0.4f, 0.3f, 0.1f, 0.0f};

    float vector[num_nodes] = {0.1f, 0.1f, 0.1f, 0.1f, 0.1f, 0.5f};
    float result[num_nodes];

    // Allocate device memory
    float *d_matrix, *d_vector, *d_result;
    cudaMalloc((void**)&d_matrix, sizeof(float) * num_nodes * num_nodes);
    cudaMalloc((void**)&d_vector, sizeof(float) * num_nodes);
    cudaMalloc((void**)&d_result, sizeof(float) * num_nodes);

    // Copy data from host to device
    cudaMemcpy(d_matrix, matrix, sizeof(float) * num_nodes * num_nodes, cudaMemcpyHostToDevice);
    cudaMemcpy(d_vector, vector, sizeof(float) * num_nodes, cudaMemcpyHostToDevice);

    // Launch the CUDA kernel
    dim3 block_size(256);
    dim3 grid_size((num_nodes + block_size.x - 1) / block_size.x);
    for (int iteration = 0; iteration < num_iterations; ++iteration) {
        pagerank_kernel<<<grid_size, block_size>>>(d_matrix, d_vector, d_result, num_nodes, damping_factor);
        cudaMemcpy(d_vector, d_result, sizeof(float) * num_nodes, cudaMemcpyDeviceToDevice);

        // Print PageRank values after each iteration
        cudaMemcpy(result, d_result, sizeof(float) * num_nodes, cudaMemcpyDeviceToHost);
        printf("Iteration %d: ", iteration + 1);
        for (int i = 0; i < num_nodes; ++i) {
            printf("%f ", result[i]);
        }
        printf("\n");

        // Check for convergence
        bool converged = true;
        for (int i = 0; i < num_nodes; ++i) {
            if (std::abs(result[i] - vector[i]) > epsilon) {
                converged = false;
                break;
            }
        }

        if (converged) {
            printf("Converged after %d iterations\n", iteration + 1);
            break;
        }
    }

    // Copy result from device to host
    cudaMemcpy(result, d_result, sizeof(float) * num_nodes, cudaMemcpyDeviceToHost);

    // Print the final PageRank values
    printf("Final PageRank values:\n");
    for (int i = 0; i < num_nodes; ++i) {
        printf("Node %d: %f\n", i, result[i]);
    }

    // Clean up
    cudaFree(d_matrix);
    cudaFree(d_vector);
    cudaFree(d_result);

    return 0;
}

/*
Iteration 1: 0.246000 0.093000 0.178000 0.212000 0.280000 0.118500 
Iteration 2: 0.144510 0.177830 0.213870 0.125002 0.174133 0.187095 
Iteration 3: 0.184005 0.115836 0.170495 0.184645 0.171828 0.189739 
Iteration 4: 0.168374 0.149415 0.171409 0.151598 0.182693 0.174196 
Iteration 5: 0.166222 0.132156 0.173582 0.162061 0.170850 0.175566 
Iteration 6: 0.165198 0.136302 0.166949 0.155445 0.170886 0.173565 
Iteration 7: 0.162968 0.132844 0.166802 0.155569 0.169123 0.170683 
Iteration 8: 0.161374 0.132568 0.164890 0.153339 0.167128 0.169633 
Iteration 9: 0.160293 0.131126 0.163569 0.152629 0.165977 0.168175 
Iteration 10: 0.159154 0.130574 0.162525 0.151420 0.164877 0.167079 
Iteration 11: 0.158319 0.129767 0.161631 0.150728 0.163936 0.166181 
Iteration 12: 0.157590 0.129263 0.160868 0.150004 0.163194 0.165415 
Iteration 13: 0.156988 0.128769 0.160256 0.149465 0.162556 0.164780 
Iteration 14: 0.156486 0.128388 0.159732 0.148989 0.162029 0.164254 
Iteration 15: 0.156068 0.128058 0.159301 0.148604 0.161590 0.163813 
Iteration 16: 0.155719 0.127789 0.158941 0.148278 0.161224 0.163446 
Iteration 17: 0.155429 0.127562 0.158641 0.148009 0.160919 0.163141 
Iteration 18: 0.155188 0.127374 0.158390 0.147784 0.160665 0.162887 
Iteration 19: 0.154986 0.127217 0.158182 0.147597 0.160454 0.162675 
Iteration 20: 0.154818 0.127087 0.158009 0.147440 0.160278 0.162498 
Iteration 21: 0.154679 0.126978 0.157864 0.147310 0.160131 0.162351 
Iteration 22: 0.154562 0.126887 0.157744 0.147202 0.160008 0.162228 
Iteration 23: 0.154465 0.126811 0.157643 0.147112 0.159906 0.162126 
Iteration 24: 0.154384 0.126749 0.157560 0.147036 0.159822 0.162041 
Iteration 25: 0.154317 0.126696 0.157490 0.146974 0.159751 0.161970 
Iteration 26: 0.154261 0.126652 0.157432 0.146922 0.159692 0.161911 
Iteration 27: 0.154214 0.126616 0.157384 0.146878 0.159643 0.161862 
Iteration 28: 0.154175 0.126586 0.157344 0.146842 0.159602 0.161821 
Iteration 29: 0.154143 0.126560 0.157310 0.146812 0.159568 0.161787 
Iteration 30: 0.154116 0.126539 0.157282 0.146787 0.159539 0.161759 
Iteration 31: 0.154093 0.126522 0.157259 0.146766 0.159516 0.161735 
Iteration 32: 0.154075 0.126507 0.157239 0.146748 0.159496 0.161715 
Iteration 33: 0.154059 0.126495 0.157223 0.146734 0.159480 0.161699 
Iteration 34: 0.154046 0.126485 0.157210 0.146722 0.159466 0.161685 
Iteration 35: 0.154035 0.126476 0.157199 0.146711 0.159455 0.161674 
Iteration 36: 0.154026 0.126469 0.157189 0.146703 0.159445 0.161664 
Iteration 37: 0.154019 0.126464 0.157181 0.146696 0.159437 0.161656 
Iteration 38: 0.154012 0.126459 0.157175 0.146690 0.159431 0.161650 
Iteration 39: 0.154007 0.126455 0.157170 0.146685 0.159425 0.161644 
Iteration 40: 0.154003 0.126451 0.157165 0.146681 0.159421 0.161639 
Iteration 41: 0.153999 0.126448 0.157161 0.146678 0.159417 0.161636 
Iteration 42: 0.153996 0.126446 0.157158 0.146675 0.159414 0.161632 
Iteration 43: 0.153994 0.126444 0.157156 0.146673 0.159411 0.161630 
Iteration 44: 0.153992 0.126442 0.157153 0.146671 0.159409 0.161628 
Iteration 45: 0.153990 0.126441 0.157152 0.146669 0.159407 0.161626 
Iteration 46: 0.153988 0.126440 0.157150 0.146668 0.159405 0.161624 
Iteration 47: 0.153987 0.126439 0.157149 0.146667 0.159404 0.161623 
Iteration 48: 0.153986 0.126438 0.157148 0.146666 0.159403 0.161622 
Iteration 49: 0.153985 0.126438 0.157147 0.146665 0.159402 0.161621 
Iteration 50: 0.153985 0.126437 0.157146 0.146664 0.159401 0.161620 
Iteration 51: 0.153984 0.126437 0.157146 0.146664 0.159401 0.161620 
Iteration 52: 0.153983 0.126436 0.157145 0.146663 0.159400 0.161619 
Iteration 53: 0.153983 0.126436 0.157145 0.146663 0.159400 0.161619 
Iteration 54: 0.153983 0.126436 0.157144 0.146663 0.159399 0.161618 
Iteration 55: 0.153982 0.126435 0.157144 0.146662 0.159399 0.161618 
Iteration 56: 0.153982 0.126435 0.157144 0.146662 0.159399 0.161618 
Iteration 57: 0.153982 0.126435 0.157144 0.146662 0.159399 0.161618 
Iteration 58: 0.153982 0.126435 0.157143 0.146662 0.159399 0.161617 
Iteration 59: 0.153982 0.126435 0.157143 0.146662 0.159398 0.161617 
Iteration 60: 0.153982 0.126435 0.157143 0.146662 0.159398 0.161617 
Iteration 61: 0.153982 0.126435 0.157143 0.146662 0.159398 0.161617 
Iteration 62: 0.153981 0.126435 0.157143 0.146661 0.159398 0.161617 
Iteration 63: 0.153981 0.126435 0.157143 0.146661 0.159398 0.161617 
Iteration 64: 0.153981 0.126435 0.157143 0.146661 0.159398 0.161617 
Iteration 65: 0.153981 0.126435 0.157143 0.146661 0.159398 0.161617 
Iteration 66: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 67: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 68: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 69: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 70: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 71: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 72: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 73: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 74: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 75: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 76: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 77: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 78: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 79: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 80: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 81: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 82: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 83: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 84: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 85: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 86: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 87: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 88: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 89: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 90: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 91: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 92: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 93: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 94: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 95: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 96: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 97: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 98: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 99: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 100: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 101: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 102: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 103: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 104: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 105: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 106: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 107: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 108: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 109: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 110: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 111: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 112: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 113: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 114: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 115: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 116: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 117: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 118: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 119: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 120: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 121: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 122: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 123: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 124: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 125: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 126: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 127: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 128: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 129: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 130: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 131: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 132: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 133: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 134: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 135: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 136: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 137: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 138: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 139: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 140: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 141: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 142: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 143: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 144: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 145: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 146: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 147: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 148: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 149: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 150: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 151: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 152: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 153: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 154: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 155: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 156: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 157: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 158: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 159: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 160: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 161: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 162: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 163: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 164: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 165: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 166: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 167: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 168: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 169: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 170: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 171: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 172: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 173: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 174: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 175: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 176: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 177: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 178: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 179: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 180: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 181: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 182: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 183: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 184: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 185: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 186: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 187: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 188: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 189: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 190: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 191: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 192: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 193: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 194: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 195: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 196: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 197: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 198: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 199: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Iteration 200: 0.153981 0.126434 0.157143 0.146661 0.159398 0.161617 
Final PageRank values:
Node 0: 0.153981
Node 1: 0.126434
Node 2: 0.157143
Node 3: 0.146661
Node 4: 0.159398
Node 5: 0.161617



*/